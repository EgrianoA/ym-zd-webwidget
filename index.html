<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>ZE Widget</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <button onclick="hideShow()" id="toggle-button" class="toggleButton">Continue to chat with Agent</button>
    <script type="text/javascript">
        const urlParams = new URLSearchParams(window.location.search);
        const key = urlParams.get('key');
        const decodedPayload = decodeURIComponent(key)
        const parsedPayload = JSON.parse(decodedPayload)
        console.log(parsedPayload)
        const scriptUrl = `https://static.zdassets.com/ekr/snippet.js?key=${parsedPayload.widgetKey}`
        var script = document.createElement('script');
        script.onload = () => {
            zE('messenger', 'open');
            zE('messenger:set', 'locale', parsedPayload.lang);
            if (parsedPayload.jwtKey && parsedPayload.jwtKey !== '') {
                zE('messenger', 'loginUser', function (callback) {
                    callback(parsedPayload.jwtKey);
                })
            }
            zE('messenger:on', 'close', () => {
                document.getElementById("toggle-button").style.display = "block"
                console.log("WIDGET CLOSED")
                window.parent.postMessage(
                    JSON.stringify({
                        event_code: "ym-client-event",
                        data: "Widget Closed"
                    }), "*");
            });
        }
        script.setAttribute('src', scriptUrl)
        script.setAttribute('id', "ze-snippet")
        document.body.appendChild(script);


        function hideShow() {
            let toggle = document.getElementById("toggle-button").style.display;
            console.log(toggle);

            if (toggle == "none") {
                document.getElementById("toggle-button").style.display = "block"
            } else {
                zE('messenger', 'open');
                document.getElementById("toggle-button").style.display = "none"
            }
        }
    </script>
</body>

</html>
